var canvas;
var context;
var canvasHistory = new Array();
var extentHistory = new Array();
var fileData = new Array();


function onLoadIndex(regiao){
              
    $.ajax({
        type: "POST",
        url: "php/src/control/control.multipolygon.php",
        data: ({
            func: "list",
            region: regiao
        }),
        dataType: "json",
        context: document.body,              
          
        success: function(data){
            for (var j in data){   

                canvas = document.getElementById("canvas");
                context = canvas.getContext("2d");
                context.strokeStyle  = '#000000';
                context.fillStyle = "#F5DEB3";

                drawMultiPolygon(data[j]);       
            }
        },
        beforeSend: function () {
            $('#loading').show();
        },
        complete: function () {
            $('#loading').hide();
        }             
    });
}

function select(point){
              
    saveHistory();              
              
    $.ajax({
        type: "POST",
        url: "php/src/control/control.multipolygon.php",
        data: ({
            func: "selectByPoint",
            point: point,
            extent: extentHistory[extentHistory.length-1]
        }),
        dataType: "json",
        context: document.body,              
          
        success: function(data){
            for (var j in data){
                context.fillStyle = "#F4A460";
                drawMultiPolygon(data[j], context);       
            }
        },
        beforeSend: function () {
            $('#loading').show();
        },
        complete: function () {
            $('#loading').hide();
        }             
    });
}

function zoom(point){
    
    saveHistory();
              
    $.ajax({
        type: "POST",
        url: "php/src/control/control.multipolygon.php",
        data: ({
            func: "zoomByPoint",
            point: point,
            extent: extentHistory[extentHistory.length-1]
        }),
        dataType: "json",
        context: document.body,              
          
        success: function(data){
            for (var j in data){   
                canvas.width = canvas.width;
                context.fillStyle = "#F5DEB3";
                drawMultiPolygon(data[j], context);       
            }
        },
        beforeSend: function () {
            $('#loading').show();
        },
        complete: function () {
            $('#loading').hide();
        }             
    });
}

function zoomExtent(extent){

    saveHistory(); 
    
    $.ajax({
        type: "POST",
        url: "php/src/control/control.multipolygon.php",
        data: ({
            func: "zoomByExtent",
            zoomExtent: extent,
            extent: extentHistory[extentHistory.length-1]
        }),
        dataType: "json",
        context: document.body,              
          
        success: function(data){
            canvas.width = canvas.width;
            context.fillStyle = "#F5DEB3";
            for (var j in data){                
                if(j == 0){
                    extentHistory.push(data[j]);
                }else{
                    drawMultiPolygon(data[j], context);  
                }
            }
        },
        beforeSend: function () {
            $('#loading').show();
        },
        complete: function () {
            $('#loading').hide();
        }             
    }); 
}

function drawMultiPolygon(data){
    for(var i in data.polygons){
        drawPolygon(data.polygons[i]);
    }
}

function drawPolygon(data){
    
    context.beginPath();
    context.lineWidth = 0.3;
    for (var i in data.points){
      
        if(i == 0){            
            context.moveTo(data.points[i].x,data.points[i].y);  
        }
        else{
            context.lineTo(data.points[i].x,data.points[i].y);
        }
    }
    context.fill();
    context.stroke();                        
}    

function saveHistory(){
    canvasHistory.push(context.getImageData(0, 0, 500, 500));
}

function drawHistory(){
    
    extentHistory.pop();
    
    if(canvasHistory.length > 0){
        context.putImageData(canvasHistory[canvasHistory.length-1], 0, 0);
        canvasHistory.pop();
    }
}
   
function getCanvasPoint(e){
    
    var canvas = $('#canvas').offset();

    var point = new Point();
    point.x = e.pageX - canvas.left;
    point.y = e.pageY - canvas.top;
    
    return point;
}

function Point(){
    this.x = null;
    this.y = null;
}

function Extent(){
    this.max = new Point();
    this.min = new Point();
}

function onLoadComboBox(id){
              
    $.ajax({
        type: "POST",
        url: "php/src/control/control.raster.php",
        data: ({
            func: "list"
        }),
        dataType: "json",
        context: document.body,              
          
        success: function(data){
            for (var i in data){
                fileData.push(data[i]);
                $(id).addOption(i, i, false);
            }
        }        
    });
}

function drawBlocks(id){
    
    if(id != parseInt(id)){
        return;
    }
    
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");   
    
    var data = fileData[id];
    var weight = data.weight;    
    var colors = weight.split(" ");  
    var size = data.blockSize;
    var numRows = data.dy;
    var numCols = data.dx;
    
    canvas.width = data.dx * size;
    canvas.height = data.dy * size;
    
    var xpos = 0; 
    var ypos = (data.dy * size) - size;        
    var color = 0;

    for(var i=0; i<=numRows; i++){
        for(var j=1; j<=numCols; j++){
            setColor(colors[color++]);
            context.fillRect(xpos,ypos,size,size);
            context.strokeRect(xpos,ypos,size,size);
            xpos+=size;
        }
        ypos-=size;
        xpos = 0;
    }
}

function setColor(weight){

    context.lineWidth = 1;   
    context.strokeStyle = "#000";
    
    if(weight == 0){
        context.fillStyle = "#FFF";
    }
    if(weight == 1){
        context.fillStyle = "#CFCFCF";
    }
    if(weight == 2){
        context.fillStyle = "#828282";
    }
    if(weight == 3){
        context.fillStyle = "#000";
    }    
}

